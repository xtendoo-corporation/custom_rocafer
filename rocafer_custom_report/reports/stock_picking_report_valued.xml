<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <record id="action_stock_picking_report_valued" model="ir.actions.report">
        <field name="name">Albarán valorado</field>
        <field name="model">stock.picking</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">rocafer_custom_report.stock_picking_report_valued</field>
        <field name="report_file">rocafer_custom_report.stock_picking_report_valued</field>
        <field name="print_report_name">'Albaran valorado - %s - %s' % (object.partner_id.name or '', object.name)
        </field>
        <field name="binding_model_id" ref="model_stock_picking"/>
        <field name="binding_type">report</field>
    </record>

    <template id="stock_picking_report_valued"
              inherit_id="stock.report_picking">

        <!--Definir si el usuario tiene el grupo de stock.manager-->
        <xpath expr="//div[hasclass('page')]" position="before">
            <t t-set="is_stock_manager" t-value="o.env.user.has_group('stock.group_stock_manager')"/>
        </xpath>

        <!--Quitar el codigo de barras-->
        <xpath expr="//div[hasclass('page')]/div[1]" position="replace">
        </xpath>

        <!--Quitar el div de la cabecera-->
        <xpath expr="//div[hasclass('page')]/div[4]" position="replace">
        </xpath>

        <!--Cabecera de la tabla Descripción-->
        <xpath expr="//table[1]/thead/tr[1]/th[1]" position="replace">
            <th>Descripción</th>
        </xpath>

        <!--Cabecera de la tabla Artículo-->
        <xpath expr="//table[1]/thead/tr[1]/th[1]" position="before">
            <th>Artículo</th>
        </xpath>

        <!--Quitar la cabecera de Desde-->
        <xpath expr="//table[1]/thead/tr[1]/th[4]" position="replace"/>

        <!--Cabecera de precio unitario, descuento, subtotal e impuestos-->
        <xpath expr="//table[1]/thead/tr" position="inside">
            <t t-if="o.sale_id and o.move_line_ids and is_stock_manager">
                <th class="text-end">
                    <strong>Precio Millar</strong>
                </th>
                <th class="text-end" groups="product.group_discount_per_so_line">
                    <strong>Descuento</strong>
                </th>
                <th class="text-end">
                    <strong>Subtotal</strong>
                </th>
            </t>
        </xpath>

        <!--Cuerpo de descripcion del producto-->
        <xpath expr="//table[1]/tbody/tr/td[1]" position="replace">
            <td>
                <span t-field="ml.product_id.name">Product Name</span>
                <br/>
                <span>
                    Nº De orden:
                    <t t-esc="ml.picking_id.sale_id.client_order_ref"/>
                </span>
                <br/>
                <span>
                    Nº De pedido:
                    <t t-esc="ml.picking_id.sale_id.name"/>
                </span>
            </td>
        </xpath>

        <!--Cuerpo de referencia del producto-->
        <xpath expr="//table[1]/tbody/tr/td[1]" position="before">
            <td>
                <span t-field="ml.product_id.default_code">-</span>
            </td>
        </xpath>

         <!--Cuerpo de cantidad sin decimales-->
        <xpath expr="//table[1]/tbody/tr/td[3]" position="replace">
<!--             <td>-->
<!--                <span t-esc="int(ml.quantity)" />-->
<!--                <span t-field="ml.product_uom_id" groups="uom.group_uom">units</span>-->
<!--                <span t-if="ml.move_id.product_packaging_id">-->
<!--                    <span t-if="o.state != 'done'">-->
<!--                        (<span t-esc="'{:,}'.format(ml.product_packaging_qty).replace(',', '.')" /> <span t-field="ml.move_id.product_packaging_id.name"/>)-->
<!--                    </span>-->
<!--                    <span t-if="o.state == 'done'">-->
<!--                        (<span t-esc="'{:,}'.format(ml.product_packaging_qty).replace(',', '.')" /> <span t-field="ml.move_id.product_packaging_id.name"/>)-->
<!--                    </span>-->
<!--                </span>-->
<!--            </td>-->
            <td class="text-end">
                <span t-esc="'{:.3f}'.format(ml.quantity).replace('.', ',')"/>
                <span t-if="ml.move_id.product_packaging_id">
                    <span t-if="o.state != 'done'">
                        (
                        <span t-esc="'{:.3f}'.format(ml.product_packaging_qty).replace('.', ',')"/>
                        <span t-field="ml.move_id.product_packaging_id.name"/>)
                    </span>
                    <span t-if="o.state == 'done'">
                        (
                        <span t-esc="'{:.3f}'.format(ml.product_packaging_qty).replace('.', ',')"/>
                        <span t-field="ml.move_id.product_packaging_id.name"/>)
                    </span>
                </span>
            </td>
        </xpath>

        <!--Cuerpo de precio unitario, subtotal-->
        <xpath expr="//table[1]/tbody/tr" position="inside">
            <t t-if="o.sale_id and o.move_line_ids and is_stock_manager">
                <td class="text-end">
                    <span t-field="ml.sale_price_unit"/>
                </td>
                <td class="text-end">
                    <span t-field="ml.sale_price_subtotal"/>
                </td>
            </t>
        </xpath>

        <!--Quitar el cuerpo desde-->
        <xpath expr="//table[1]/tbody/tr/td[4]" position="replace"/>

        <!--Tabla del subtotal y total-->
        <xpath expr="//table[1]" position="after">
            <t t-if="o.sale_id and o.move_line_ids and is_stock_manager">
                <table class="table table-sm mt32">
                    <thead>
                        <tr>
                            <th class="text-end">
                                <strong>Base imponible</strong>
                            </th>
                            <th class="text-end">
                                <strong>Impuestos</strong>
                            </th>
                            <th class="text-end">
                                <strong>Total</strong>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-end">
                                <span t-field="o.amount_untaxed"/>
                            </td>
                            <td class="text-end">
                                <span t-field="o.amount_tax"/>
                            </td>
                            <td class="text-end">
                                <span t-field="o.amount_total"/>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </t>
        </xpath>
    </template>
</odoo>
